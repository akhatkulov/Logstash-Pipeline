# =============================================================================
# 05-routing.conf - Agent turini aniqlash va yo'naltirish metadatasini o'rnatish
# =============================================================================

filter {
  # Qabul qilish vaqtini darhol yozib olish
  ruby {
    code => 'event.set("[event][ingested]", Time.now.utc.iso8601(3))'
  }

  # agent_token tekshiruvi va metadataga o'tkazish
  if [agent_token] and [agent_token] != "unknown" and [agent_token] != "" {
    mutate {
      add_field => { "[@metadata][agent_token]" => "%{[agent_token]}" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][agent_token]" => "no-token" }
    }
  }

  # agent_id tekshiruvi (Beats'dan keladi)
  if [agent_id] {
    mutate {
      convert => { "agent_id" => "string" }
      add_field => { "[@metadata][agent_id]" => "%{[agent_id]}" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][agent_id]" => "0" }
    }
  }

  # Beatsdan kelgan agent.type asosida yo'naltirish
  if [agent][type] == "filebeat" or [agent][type] == "updive-file" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "file"
        "[@metadata][target_index]" => "filebeat-other-%{+YYYY.MM.dd}"
      }
    }
  } else if [agent][type] == "auditbeat" or [agent][type] == "updive-audit" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "audit"
        "[@metadata][target_index]" => "auditbeat-%{[agent][version]}-%{+YYYY.MM.dd}"
      }
    }
  } else if [agent][type] == "metricbeat" or [agent][type] == "updive-metric" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "metric"
        "[@metadata][target_index]" => "metricbeat-%{[agent][version]}-%{+YYYY.MM.dd}"
      }
    }
  } else if [agent][type] == "heartbeat" or [agent][type] == "updive-heart" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "heart"
        "[@metadata][target_index]" => "heartbeat-%{[agent][version]}-%{+YYYY.MM.dd}"
      }
    }
  } else if [agent][type] == "packetbeat" or [agent][type] == "updive-packet" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "packet"
        "[@metadata][target_index]" => "packetbeat-%{[agent][version]}-%{+YYYY.MM.dd}"
      }
    }
  } else if [agent][type] == "winlogbeat" or [agent][type] == "updive-win" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "win"
        "[@metadata][target_index]" => "winlogbeat-%{[agent][version]}-%{+YYYY.MM.dd}"
      }
    }
  } else {
    mutate {
      add_field => { "[@metadata][updive_type]" => "unknown" }
    }
  }

  # Agent turini UpDive nomlanishiga o'zgartirish
  if [@metadata][updive_type] == "file" {
    mutate { replace => { "[agent][type]" => "updive-file" } }
  } else if [@metadata][updive_type] == "audit" {
    mutate { replace => { "[agent][type]" => "updive-audit" } }
  } else if [@metadata][updive_type] == "metric" {
    mutate { replace => { "[agent][type]" => "updive-metric" } }
  } else if [@metadata][updive_type] == "heart" {
    mutate { replace => { "[agent][type]" => "updive-heart" } }
  } else if [@metadata][updive_type] == "packet" {
    mutate { replace => { "[agent][type]" => "updive-packet" } }
  } else if [@metadata][updive_type] == "win" {
    mutate { replace => { "[agent][type]" => "updive-win" } }
  }

  # ECS versiyasini o'rnatish
  mutate {
    add_field => { "[ecs][version]" => "8.11.0" }
  }

  # ===========================================================================
  # Maxfiylik va Brending: Elastic Beats metama'lumotlarini tozalash
  # ===========================================================================
  mutate {
    # GitHub linklari va original build ma'lumotlarini o'chirish
    remove_field => [ 
      "[agent][version]", 
      "[agent][build]", 
      "[agent][ephemeral_id]",
      "[agent][id]",
      "[user_agent][original]"
    ]
  }

  # Agent nomini UpDive ga moslashtirish (agar mavjud bo'lmasa)
  if ![agent][name] or [agent][name] == "" {
    mutate {
      add_field => { "[agent][name]" => "updive-agent" }
    }
  }
}
