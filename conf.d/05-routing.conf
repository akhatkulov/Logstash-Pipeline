# =============================================================================
# 05-routing.conf - Agent turini aniqlash va yo'naltirish metadatasini o'rnatish
# Dinamik index nomlari: winlogbeat-*, auditbeat-*, filebeat-manba-tur-*
# =============================================================================

filter {
  # Qabul qilish vaqtini darhol yozib olish
  ruby {
    code => 'event.set("[event][ingested]", Time.now.utc.iso8601(3))'
  }

  # =========================================================================
  # AGENT_ID VA AGENT_TOKEN - Elasticsearch'ga yuboriladi!
  # Beats'dan agent_id va agent_token sifatida keladi
  # ECS: agent.id va agent.token ga o'tkaziladi
  # =========================================================================
  
  # agent_token - autentifikatsiya uchun
  if [agent_token] and [agent_token] != "unknown" and [agent_token] != "" {
    mutate {
      add_field => { 
        "[@metadata][agent_token]" => "%{[agent_token]}" 
        "[agent][token]" => "%{[agent_token]}"  # ES ga yoziladi
      }
    }
  } else {
    mutate {
      add_field => { 
        "[@metadata][agent_token]" => "no-token"
        "[agent][token]" => "no-token"
      }
    }
  }

  # agent_id - Beats'dan keladi
  if [agent_id] {
    mutate {
      convert => { "agent_id" => "string" }
      add_field => { 
        "[@metadata][agent_id]" => "%{[agent_id]}"
        "[agent][id]" => "%{[agent_id]}"  # ES ga yoziladi
      }
    }
  } else {
    mutate {
      add_field => { 
        "[@metadata][agent_id]" => "0"
        "[agent][id]" => "0"
      }
    }
  }

  # =========================================================================
  # AGENT TURINI ANIQLASH VA INDEX NOMLASH
  # =========================================================================

  # ----- FILEBEAT -----
  # Format: filebeat-manba-tur-YYYY.MM.dd
  if [agent][type] == "filebeat" or [agent][type] == "updive-file" {
    mutate {
      add_field => { "[@metadata][updive_type]" => "file" }
    }
    
    # Log turini aniqlash
    if [log][file][path] {
      ruby {
        code => '
          log_path = event.get("[log][file][path]").to_s.downcase
          
          # Nginx
          if log_path.include?("nginx") && log_path.include?("access")
            event.set("[@metadata][log_source]", "nginx")
            event.set("[@metadata][log_type]", "access")
          elsif log_path.include?("nginx") && log_path.include?("error")
            event.set("[@metadata][log_source]", "nginx")
            event.set("[@metadata][log_type]", "error")
          # Apache
          elsif log_path.include?("apache") && log_path.include?("access")
            event.set("[@metadata][log_source]", "apache")
            event.set("[@metadata][log_type]", "access")
          elsif log_path.include?("apache") && log_path.include?("error")
            event.set("[@metadata][log_source]", "apache")
            event.set("[@metadata][log_type]", "error")
          # Syslog
          elsif log_path.include?("syslog") || log_path.include?("/var/log/messages")
            event.set("[@metadata][log_source]", "system")
            event.set("[@metadata][log_type]", "syslog")
          # Auth log
          elsif log_path.include?("auth") || log_path.include?("secure")
            event.set("[@metadata][log_source]", "system")
            event.set("[@metadata][log_type]", "auth")
          # Audit log
          elsif log_path.include?("audit")
            event.set("[@metadata][log_source]", "system")
            event.set("[@metadata][log_type]", "audit")
          # Tomcat
          elsif log_path.include?("tomcat") && log_path.include?("access")
            event.set("[@metadata][log_source]", "tomcat")
            event.set("[@metadata][log_type]", "access")
          elsif log_path.include?("tomcat") && log_path.include?("catalina")
            event.set("[@metadata][log_source]", "tomcat")
            event.set("[@metadata][log_type]", "catalina")
          # IIS
          elsif log_path.include?("iis") || log_path.include?("w3svc")
            event.set("[@metadata][log_source]", "iis")
            event.set("[@metadata][log_type]", "access")
          # Postfix
          elsif log_path.include?("mail") || log_path.include?("postfix")
            event.set("[@metadata][log_source]", "postfix")
            event.set("[@metadata][log_type]", "mail")
          # Default
          else
            event.set("[@metadata][log_source]", "other")
            event.set("[@metadata][log_type]", "log")
          end
        '
      }
    } else if [event][module] {
      # Filebeat module dan olish
      mutate {
        add_field => { 
          "[@metadata][log_source]" => "%{[event][module]}"
        }
      }
      if [fileset][name] {
        mutate {
          add_field => { "[@metadata][log_type]" => "%{[fileset][name]}" }
        }
      } else {
        mutate {
          add_field => { "[@metadata][log_type]" => "log" }
        }
      }
    } else {
      # Default
      mutate {
        add_field => { 
          "[@metadata][log_source]" => "other"
          "[@metadata][log_type]" => "log"
        }
      }
    }
    
    # Filebeat index formati: filebeat-manba-tur-YYYY.MM.dd
    mutate {
      add_field => { 
        "[@metadata][target_index]" => "filebeat-%{[@metadata][log_source]}-%{[@metadata][log_type]}-%{+YYYY.MM.dd}"
      }
    }
  }

  # ----- AUDITBEAT -----  
  else if [agent][type] == "auditbeat" or [agent][type] == "updive-audit" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "audit"
        "[@metadata][target_index]" => "auditbeat-%{+YYYY.MM.dd}"
      }
    }
  }

  # ----- METRICBEAT -----
  else if [agent][type] == "metricbeat" or [agent][type] == "updive-metric" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "metric"
        "[@metadata][target_index]" => "metricbeat-%{+YYYY.MM.dd}"
      }
    }
  }

  # ----- HEARTBEAT -----
  else if [agent][type] == "heartbeat" or [agent][type] == "updive-heart" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "heart"
        "[@metadata][target_index]" => "heartbeat-%{+YYYY.MM.dd}"
      }
    }
  }

  # ----- PACKETBEAT -----
  else if [agent][type] == "packetbeat" or [agent][type] == "updive-packet" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "packet"
        "[@metadata][target_index]" => "packetbeat-%{+YYYY.MM.dd}"
      }
    }
  }

  # ----- WINLOGBEAT -----
  else if [agent][type] == "winlogbeat" or [agent][type] == "updive-win" {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "win"
        "[@metadata][target_index]" => "winlogbeat-%{+YYYY.MM.dd}"
      }
    }
  }

  # ----- UNKNOWN -----
  else {
    mutate {
      add_field => { 
        "[@metadata][updive_type]" => "unknown"
        "[@metadata][target_index]" => "unknown-%{+YYYY.MM.dd}"
      }
    }
  }

  # =========================================================================
  # AGENT TURINI UPDIVE NOMLANISHIGA O'ZGARTIRISH
  # =========================================================================
  if [@metadata][updive_type] == "file" {
    mutate { replace => { "[agent][type]" => "updive-file" } }
  } else if [@metadata][updive_type] == "audit" {
    mutate { replace => { "[agent][type]" => "updive-audit" } }
  } else if [@metadata][updive_type] == "metric" {
    mutate { replace => { "[agent][type]" => "updive-metric" } }
  } else if [@metadata][updive_type] == "heart" {
    mutate { replace => { "[agent][type]" => "updive-heart" } }
  } else if [@metadata][updive_type] == "packet" {
    mutate { replace => { "[agent][type]" => "updive-packet" } }
  } else if [@metadata][updive_type] == "win" {
    mutate { replace => { "[agent][type]" => "updive-win" } }
  }

  # =========================================================================
  # ECS VERSIYASI
  # =========================================================================
  mutate {
    add_field => { "[ecs][version]" => "8.11.0" }
  }

  # =========================================================================
  # MAXFIYLIK: Keraksiz Elastic metadatalarini tozalash
  # agent.id va agent.token SAQLANADI!
  # =========================================================================
  mutate {
    remove_field => [ 
      "[agent][version]", 
      "[agent][build]", 
      "[agent][ephemeral_id]"
      # "[agent][id]" - BU SAQLANADI!
    ]
  }

  # Agent nomini UpDive ga moslashtirish
  if ![agent][name] or [agent][name] == "" {
    mutate {
      add_field => { "[agent][name]" => "updive-agent" }
    }
  }

  # =========================================================================
  # ORIGINAL agent_id va agent_token FIELDLARINI O'CHIRISH
  # (endi agent.id va agent.token ga ko'chirildi)
  # =========================================================================
  mutate {
    remove_field => [ "agent_id", "agent_token" ]
  }
}
