# Postfix Mail Server Filter (ECS 8.x)
# File: 23-postfix.conf

filter {
  if [log][file][path] =~ /mail/ or "postfix" in [tags] {
    
    # 1. Syslog Header-ni ajratish
    grok {
      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:[host][name]} %{PROG:[process][name]}(?:\[%{POSINT:[process][pid]}\])?: %{GREEDYDATA:postfix_message}" }
    }

    # 2. Shovqinni (noise) o'chirish
    if [postfix_message] =~ /statistics|daemon started|connect from localhost/ { drop { } }

    # 3. Postfix tarkibiy qismlari bo'yicha parse qilish
    if [process][name] == "postfix/smtpd" {
      # Login failure (Brute Force testi)
      if [postfix_message] =~ /authentication failed/ {
        grok {
          match => { "postfix_message" => "warning: %{HOSTNAME:[source][domain]}\[%{IP:[source][ip]}\]: SASL %{DATA:[event][reason]} authentication failed: %{GREEDYDATA:error_details}" }
          add_tag => ["Login_Failure", "Security_Alert"]
        }
      }
      # Client ulanishi va SASL username
      grok {
        match => { "postfix_message" => "%{DATA:[postfix][queue_id]}: client=%{DATA:[source][domain]}\[%{IP:[source][ip]}\](?:, sasl_method=%{WORD:[postfix][sasl_method]}, sasl_username=%{NOTSPACE:[user][name]})?" }
      }
    }

    if [process][name] == "postfix/cleanup" {
      grok {
        match => { "postfix_message" => "%{DATA:[postfix][queue_id]}: message-id=<%{NOTSPACE:[email][message_id]}>" }
      }
    }

    if [process][name] in ["postfix/smtp", "postfix/lmtp", "postfix/pipe"] {
      grok {
        match => { "postfix_message" => "%{DATA:[postfix][queue_id]}: to=<%{NOTSPACE:[email][to]}>, relay=%{DATA:[postfix][relay]}\[%{IP:[destination][ip]}\]:%{POSINT:[destination][port]}, (?:.*)?status=%{WORD:[event][outcome]} \(%{GREEDYDATA:[event][reason]}\)" }
      }
    }

    if [process][name] == "postfix/qmgr" {
      grok {
        match => { "postfix_message" => "%{DATA:[postfix][queue_id]}: from=<%{NOTSPACE:[email][from]}>, size=%{NUMBER:[source][bytes]:int}" }
      }
    }

    # 4. Tozalash (Braketlarni <...> olib tashlash)
    if [email][from] { mutate { gsub => ["[email][from]", "[<>]", ""] } }
    if [email][to] { mutate { gsub => ["[email][to]", "[<>]", ""] } }

    # 5. ECS Mappings & Enrichment
    mutate {
      add_field => { 
        "[event][module]" => "postfix" 
        "[event][dataset]" => "postfix.log"
      }
    }

    # GeoIP - faqat tashqi IP bo'lsa
    if [source][ip] and [source][ip] !~ /^(127\.|10\.|172\.1[6-9]\.|192\.168\.)/ {
      geoip { source => "[source][ip]" target => "[source][geo]" }
    }

    # Vaqtni standartlashtirish
    date {
      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
      target => "@timestamp"
    }

    # 6. Keraksiz maydonlarni o'chirish
    mutate { remove_field => ["message", "postfix_message", "syslog_timestamp"] }
  }
}
