# =============================================================================
# 12-filter-updive-metric.conf - Metricbeat/updive-metric qayta ishlash
# Agressiv tozalash bilan ishlash ko'rsatkichlari (event.kind=metric)
# =============================================================================

filter {
  if [@metadata][updive_type] == "metric" {

    # Asosiy voqea metadatasini o'rnatish - metriklar voqea EMAS
    mutate {
      add_field => {
        "[event][module]" => "updive-metric"
        "[event][kind]" => "metric"
      }
    }

    # -------------------------------------------------------------------------
    # metricset asosida dataset tayinlash
    # -------------------------------------------------------------------------
    if [metricset][name] {
      mutate {
        add_field => { "[event][dataset]" => "updive-metric.%{[metricset][module]}.%{[metricset][name]}" }
      }
    } else {
      mutate {
        add_field => { "[event][dataset]" => "updive-metric.system" }
      }
    }

    # -------------------------------------------------------------------------
    # Tizim CPU metrikalari
    # -------------------------------------------------------------------------
    if [metricset][name] == "cpu" {
      # Faqat zarur CPU metrikalarini saqlash
      mutate {
        remove_field => [
          "[system][cpu][nice][norm][pct]",
          "[system][cpu][irq][norm][pct]",
          "[system][cpu][softirq][norm][pct]",
          "[system][cpu][steal][norm][pct]"
        ]
      }
    }

    # -------------------------------------------------------------------------
    # Tizim xotira metrikalari
    # -------------------------------------------------------------------------
    if [metricset][name] == "memory" {
      # Faqat zarur xotira metrikalarini saqlash
      mutate {
        remove_field => [
          "[system][memory][hugepages]",
          "[system][memory][page_stats]"
        ]
      }
    }

    # -------------------------------------------------------------------------
    # Fayl tizimi metrikalari
    # -------------------------------------------------------------------------
    if [metricset][name] == "filesystem" {
      # tmpfs va boshqa psevdo fayl tizimlarini tashlab yuborish
      if [system][filesystem][type] =~ /^(tmpfs|devtmpfs|squashfs|overlay)$/ {
        drop { }
      }
    }

    # -------------------------------------------------------------------------
    # Jarayon metrikalari
    # -------------------------------------------------------------------------
    if [metricset][name] == "process" {
      # Jarayon maydonlarini ECS ga normalizatsiya qilish
      if [system][process][name] and ![process][name] {
        mutate {
          add_field => { "[process][name]" => "%{[system][process][name]}" }
        }
      }

      if [system][process][pid] and ![process][pid] {
        mutate {
          add_field => { "[process][pid]" => "%{[system][process][pid]}" }
        }
      }

      if [system][process][cmdline] and ![process][command_line] {
        mutate {
          add_field => { "[process][command_line]" => "%{[system][process][cmdline]}" }
        }
      }

      # Normalizatsiyadan keyin batafsil ichma-ich maydonlarni olib tashlash
      mutate {
        remove_field => [
          "[system][process][cgroup]",
          "[system][process][fd]"
        ]
      }
    }

    # -------------------------------------------------------------------------
    # Tarmoq metrikalari
    # -------------------------------------------------------------------------
    if [metricset][name] == "network" {
      # Loopback interfeys metrikalarini tashlab yuborish - odatda shovqin
      if [system][network][name] == "lo" {
        drop { }
      }
    }

    # -------------------------------------------------------------------------
    # Docker/Konteyner metrikalari
    # -------------------------------------------------------------------------
    if [metricset][module] == "docker" {
      # Konteyner maydonlarini normalizatsiya qilish
      if [docker][container][name] and ![container][name] {
        mutate {
          add_field => { "[container][name]" => "%{[docker][container][name]}" }
        }
      }

      if [docker][container][id] and ![container][id] {
        mutate {
          add_field => { "[container][id]" => "%{[docker][container][id]}" }
        }
      }
    }

    # -------------------------------------------------------------------------
    # Kubernetes metrikalari
    # -------------------------------------------------------------------------
    if [metricset][module] == "kubernetes" {
      # Kubernetes metadatasi odatda Beats'dan ECS-ga mos keladi
      # Faqat namespace va pod to'g'ri joyda ekanligini ta'minlash
    }

    # -------------------------------------------------------------------------
    # Metrikalar uchun agressiv maydon tozalash
    # -------------------------------------------------------------------------
    mutate {
      remove_field => [
        "[event][original]",
        "[log]",
        "[input]",
        "[prospector]"
      ]
    }

    # Bo'sh/null maydonlarni olib tashlash
    ruby {
      code => '
        def prune(hash)
          return hash unless hash.is_a?(Hash)
          hash.each do |k, v|
            if v.nil? || v == "" || (v.is_a?(Hash) && v.empty?)
              hash.delete(k)
            elsif v.is_a?(Hash)
              prune(v)
              hash.delete(k) if v.empty?
            end
          end
          hash
        end

        event_hash = event.to_hash
        prune(event_hash)
      '
    }

    # -------------------------------------------------------------------------
    # Past qiymatli metrik namunalarni tashlab yuborish (yuqori chastotali metrikalar uchun sampling)
    # -------------------------------------------------------------------------
    # Hajmni kamaytirish uchun soniyalik metrikalarning faqat ~10% ni saqlash
    if [metricset][name] =~ /^(cpu|memory|network|diskio)$/ {
      ruby {
        code => '
          # Oddiy sampling: agar soniya 0 bilan tugasa saqlash
          ts = event.get("@timestamp")
          if ts
            sec = ts.to_i % 10
            event.cancel if sec != 0
          end
        '
      }
    }
  }
}
