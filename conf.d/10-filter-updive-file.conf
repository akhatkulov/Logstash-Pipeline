# =============================================================================
# 10-filter-updive-file.conf - Filebeat/updive-file qayta ishlash
# Qamrab oladi: veb loglar, syslog, autentifikatsiya loglari, ilova loglari
# =============================================================================

filter {
  if [@metadata][updive_type] == "file" {

    # Asosiy voqea metadatasini o'rnatish
    mutate {
      add_field => {
        "[event][module]" => "updive-file"
        "[event][kind]" => "event"
      }
    }

    # -------------------------------------------------------------------------
    # Veb kirish loglari (Apache/Nginx)
    # -------------------------------------------------------------------------
    if [fileset][name] == "access" or [log][file][path] =~ /access/ {
      mutate {
        add_field => {
          "[@metadata][target_index]" => "filebeat-nginx-access-%{+YYYY.MM.dd}"
          "[event][dataset]" => "updive-file.web.access"
          "[event][category]" => "web"
          "[event][type]" => "access"
        }
      }

      # Xabar mavjud bo'lsa, birlashtirilgan log formatini tahlil qilish
      if [message] {
        grok {
          match => {
            "message" => '%{IPORHOST:[source][ip]} - %{DATA:[user][name]} \[%{HTTPDATE:[_temp][timestamp]}\] "%{WORD:[http][request][method]} %{URIPATHPARAM:[url][path]} HTTP/%{NUMBER:[http][version]}" %{NUMBER:[http][response][status_code]:int} %{NUMBER:[http][response][body][bytes]:int} "%{DATA:[http][request][referrer]}" "%{DATA:[user_agent][original]}"'
          }
          tag_on_failure => ["_grok_web_access_failure"]
        }

        # Logdan vaqt tamg'asini tahlil qilish
        if [_temp][timestamp] {
          date {
            match => ["[_temp][timestamp]", "dd/MMM/yyyy:HH:mm:ss Z"]
            target => "@timestamp"
          }
        }

        # Status koddan natijani aniqlash
        if [http][response][status_code] {
          if [http][response][status_code] < 400 {
            mutate { add_field => { "[event][outcome]" => "success" } }
          } else if [http][response][status_code] >= 400 and [http][response][status_code] < 500 {
            mutate { add_field => { "[event][outcome]" => "failure" } }
          } else {
            mutate { add_field => { "[event][outcome]" => "failure" } }
          }
        }
      }

      # Foydalanuvchi agentini tahlil qilish
      if [user_agent][original] and [user_agent][original] != "-" {
        useragent {
          source => "[user_agent][original]"
          target => "[user_agent]"
          ecs_compatibility => v8
        }
      }
    }

    # -------------------------------------------------------------------------
    # Veb xato loglari (Apache/Nginx)
    # -------------------------------------------------------------------------
    else if [fileset][name] == "error" or [log][file][path] =~ /error/ {
      mutate {
        add_field => {
          "[@metadata][target_index]" => "filebeat-nginx-error-%{+YYYY.MM.dd}"
          "[event][dataset]" => "updive-file.web.error"
          "[event][category]" => "web"
          "[event][type]" => "error"
        }
      }
    }

    # -------------------------------------------------------------------------
    # Autentifikatsiya loglari (ssh, pam, sudo)
    # -------------------------------------------------------------------------
    else if [fileset][name] == "auth" or [log][file][path] =~ /(auth|secure)/ {
      mutate {
        replace => {
          "[event][category]" => "authentication"
          "[event][dataset]" => "updive-file.system.auth"
        }
      }

      # SSH autentifikatsiyasi
      if [message] =~ /sshd/ {
        if [message] =~ /Accepted/ {
          mutate {
            add_field => {
              "[event][type]" => "start"
              "[event][outcome]" => "success"
              "[event][action]" => "ssh_login"
            }
          }
          grok {
            match => {
              "message" => "Accepted %{WORD:[_temp][auth_method]} for %{USERNAME:[user][name]} from %{IP:[source][ip]} port %{NUMBER:[source][port]:int}"
            }
            tag_on_failure => ["_grok_ssh_accept_failure"]
          }
        } else if [message] =~ /Failed/ {
          mutate {
            add_field => {
              "[event][type]" => "start"
              "[event][outcome]" => "failure"
              "[event][action]" => "ssh_login"
            }
          }
          grok {
            match => {
              "message" => "Failed %{WORD:[_temp][auth_method]} for( invalid user)? %{USERNAME:[user][name]} from %{IP:[source][ip]} port %{NUMBER:[source][port]:int}"
            }
            tag_on_failure => ["_grok_ssh_fail_failure"]
          }
        }
      }

      # Sudo buyruqlari
      if [message] =~ /sudo/ {
        mutate {
          add_field => {
            "[event][type]" => "info"
            "[event][action]" => "sudo_command"
          }
        }
        grok {
          match => {
            "message" => "%{USERNAME:[user][name]} : TTY=%{DATA:[_temp][tty]} ; PWD=%{DATA:[process][working_directory]} ; USER=%{USERNAME:[user][effective][name]} ; COMMAND=%{GREEDYDATA:[process][command_line]}"
          }
          tag_on_failure => ["_grok_sudo_failure"]
        }
      }
    }

    # -------------------------------------------------------------------------
    # Syslog / Umumiy tizim loglari
    # -------------------------------------------------------------------------
    else if [fileset][name] == "syslog" or [log][file][path] =~ /syslog|messages/ {
      mutate {
        replace => {
          "[event][category]" => "host"
          "[event][dataset]" => "updive-file.system.syslog"
          "[event][type]" => "info"
        }
      }

      grok {
        match => {
          "message" => "%{SYSLOGTIMESTAMP:[_temp][syslog_timestamp]} %{HOSTNAME:[host][hostname]} %{PROG:[process][name]}(?:\[%{POSINT:[process][pid]:int}\])?: %{GREEDYDATA:[_temp][syslog_message]}"
        }
        tag_on_failure => ["_grok_syslog_failure"]
      }
    }

    # -------------------------------------------------------------------------
    # source.ip uchun GeoIP boyitish
    # -------------------------------------------------------------------------
    if [source][ip] {
      geoip {
        source => "[source][ip]"
        target => "[source][geo]"
        ecs_compatibility => v8
        tag_on_failure => ["_geoip_source_failure"]
      }
      geoip {
        source => "[source][ip]"
        target => "[source][as]"
        default_database_type => "ASN"
        ecs_compatibility => v8
        tag_on_failure => ["_geoip_asn_source_failure"]
      }
    }

    # -------------------------------------------------------------------------
    # Bog'liq maydonlar massivini to'ldirish
    # -------------------------------------------------------------------------
    ruby {
      code => '
        related_ips = []
        related_users = []

        # IPlarni yigish
        source_ip = event.get("[source][ip]")
        related_ips << source_ip if source_ip

        dest_ip = event.get("[destination][ip]")
        related_ips << dest_ip if dest_ip

        client_ip = event.get("[client][ip]")
        related_ips << client_ip if client_ip

        # Foydalanuvchilarni yigish
        user_name = event.get("[user][name]")
        related_users << user_name if user_name

        effective_user = event.get("[user][effective][name]")
        related_users << effective_user if effective_user

        # Massivlarni sozlash
        event.set("[related][ip]", related_ips.uniq) unless related_ips.empty?
        event.set("[related][user]", related_users.uniq) unless related_users.empty?
      '
    }

    # -------------------------------------------------------------------------
    # Vaqtinchalik maydonlarni tozalash
    # -------------------------------------------------------------------------
    mutate {
      remove_field => ["[_temp]"]
    }

    # -------------------------------------------------------------------------
    # Shovqin nazorati - past qiymatli voqealarni tashlab yuborish
    # -------------------------------------------------------------------------
    if [message] =~ /^$/ {
      drop { }
    }

    # Veb loglardan health check shovqinini olib tashlash
    if [url][path] =~ /^\/(health|healthz|ready|live|status|ping)$/ and [http][response][status_code] == 200 {
      drop { }
    }
  }
}
