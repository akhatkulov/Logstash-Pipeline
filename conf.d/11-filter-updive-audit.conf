# =============================================================================
# 11-filter-updive-audit.conf - Auditbeat/updive-audit qayta ishlash
# Yuqori signalli xavfsizlik voqealari: autentifikatsiya, jarayon, fayl, konfiguratsiya
# =============================================================================

filter {
  if [@metadata][updive_type] == "audit" {

    # Asosiy voqea metadatasini o'rnatish
    mutate {
      add_field => {
        "[event][module]" => "updive-audit"
        "[event][kind]" => "event"
      }
    }

    # -------------------------------------------------------------------------
    # Autentifikatsiya voqealari (PAM, login)
    # -------------------------------------------------------------------------
    if [event][action] =~ /(login|authentication|pam)/ or [auditd][summary][how] =~ /login|sshd|su/ {
      # ECS: event.category massiv sifatida
      ruby {
        code => 'event.set("[event][category]", ["authentication"])'
      }

      if [event][outcome] == "success" or [auditd][result] == "success" {
        mutate {
          add_field => {
            "[event][type]" => "start"
            "[event][outcome]" => "success"
          }
        }
      } else {
        mutate {
          add_field => {
            "[event][type]" => "start"
            "[event][outcome]" => "failure"
          }
        }
      }
    }

    # -------------------------------------------------------------------------
    # Jarayon voqealari (exec, fork, exit)
    # -------------------------------------------------------------------------
    else if [event][action] =~ /(exec|fork|exit|ran-command)/ or [auditd][summary][how] {
      # ECS: event.category massiv sifatida
      ruby {
        code => 'event.set("[event][category]", ["process"])'
      }

      if [event][action] =~ /exec|ran-command/ {
        mutate { add_field => { "[event][type]" => "start" } }
      } else if [event][action] =~ /exit/ {
        mutate { add_field => { "[event][type]" => "end" } }
      } else {
        mutate { add_field => { "[event][type]" => "info" } }
      }

      # Jarayon maydonlarini normalizatsiya qilish
      if [auditd][summary][actor][primary] and ![user][name] {
        mutate {
          add_field => { "[user][name]" => "%{[auditd][summary][actor][primary]}" }
        }
      }

      if [auditd][summary][how] and ![process][executable] {
        mutate {
          add_field => { "[process][executable]" => "%{[auditd][summary][how]}" }
        }
      }
    }

    # -------------------------------------------------------------------------
    # Fayl voqealari (ochish, yaratish, o'chirish, o'zgartirish)
    # -------------------------------------------------------------------------
    else if [event][action] =~ /(opened|created|deleted|modified|renamed|moved|wrote)/ or [file][path] {
      # ECS: event.category massiv sifatida
      ruby {
        code => 'event.set("[event][category]", ["file"])'
      }

      if [event][action] =~ /created/ {
        mutate { add_field => { "[event][type]" => "creation" } }
      } else if [event][action] =~ /deleted/ {
        mutate { add_field => { "[event][type]" => "deletion" } }
      } else if [event][action] =~ /modified|wrote/ {
        mutate { add_field => { "[event][type]" => "change" } }
      } else {
        mutate { add_field => { "[event][type]" => "access" } }
      }
    }

    # -------------------------------------------------------------------------
    # Konfiguratsiya voqealari
    # -------------------------------------------------------------------------
    else if [event][action] =~ /(config|settings|registry)/ {
      # ECS: event.category massiv sifatida
      ruby {
        code => 'event.set("[event][category]", ["configuration"])'
      }
      mutate {
        add_field => { "[event][type]" => "change" }
      }
    }

    # -------------------------------------------------------------------------
    # Tarmoq voqealari
    # -------------------------------------------------------------------------
    else if [event][action] =~ /(socket|connect|bind|accept)/ or [network][type] {
      # ECS: event.category massiv sifatida
      ruby {
        code => 'event.set("[event][category]", ["network"])'
      }
      mutate {
        add_field => { "[event][type]" => "connection" }
      }
    }

    # -------------------------------------------------------------------------
    # Standart toifalash
    # -------------------------------------------------------------------------
    else {
      if ![event][category] {
        mutate {
          add_field => {
            "[event][category]" => "host"
            "[event][type]" => "info"
          }
        }
      }
    }

    # -------------------------------------------------------------------------
    # GeoIP boyitish
    # -------------------------------------------------------------------------
    if [source][ip] {
      geoip {
        source => "[source][ip]"
        target => "[source][geo]"
        ecs_compatibility => v8
        tag_on_failure => ["_geoip_source_failure"]
      }
    }

    if [destination][ip] {
      geoip {
        source => "[destination][ip]"
        target => "[destination][geo]"
        ecs_compatibility => v8
        tag_on_failure => ["_geoip_dest_failure"]
      }
    }

    # -------------------------------------------------------------------------
    # Bog'liq maydonlarni to'ldirish
    # -------------------------------------------------------------------------
    ruby {
      code => '
        related_ips = []
        related_users = []
        related_hashes = []

        ["[source][ip]", "[destination][ip]", "[client][ip]", "[server][ip]"].each do |path|
          val = event.get(path)
          related_ips << val if val
        end

        ["[user][name]", "[user][effective][name]", "[user][target][name]"].each do |path|
          val = event.get(path)
          related_users << val if val
        end

        ["[file][hash][sha256]", "[file][hash][sha1]", "[file][hash][md5]"].each do |path|
          val = event.get(path)
          related_hashes << val if val
        end

        event.set("[related][ip]", related_ips.uniq) unless related_ips.empty?
        event.set("[related][user]", related_users.uniq) unless related_users.empty?
        event.set("[related][hash]", related_hashes.uniq) unless related_hashes.empty?
      '
    }

    # Dataset tayinlash
    if ![event][dataset] {
      mutate {
        add_field => { "[event][dataset]" => "updive-audit.security" }
      }
    }

    # -------------------------------------------------------------------------
    # Shovqin nazorati
    # -------------------------------------------------------------------------
    if [event][action] == "opened-file" and [file][path] {
      if [file][path] =~ /^\/proc\// or [file][path] =~ /^\/sys\// {
        drop { }
      }
    }

    if [process][name] == "cron" and [event][outcome] != "failure" {
      if [event][action] !~ /(exec|command)/ {
        drop { }
      }
    }
  }
}
