# =============================================================================
# 15-filter-updive-win.conf - Winlogbeat/updive-win qayta ishlash
# Windows xavfsizlik voqealari: kirish, hisob, imtiyoz, jarayon voqealari
# =============================================================================

filter {
  if [@metadata][updive_type] == "win" {

    # Asosiy voqea metadatasini o'rnatish
    mutate {
      add_field => {
        "[event][module]" => "updive-win"
        "[event][kind]" => "event"
      }
    }

    # -------------------------------------------------------------------------
    # Windows Event ID'dan ECS'ga xaritalash
    # -------------------------------------------------------------------------
    # Yo'naltirish uchun Event ID olish
    if [winlog][event_id] {
      mutate {
        add_field => { "[event][code]" => "%{[winlog][event_id]}" }
      }
    }

    # -------------------------------------------------------------------------
    # AUTENTIFIKATSIYA VOQEALARI (Kirish/Chiqish)
    # -------------------------------------------------------------------------
    # 4624 - Muvaffaqiyatli kirish
    if [winlog][event_id] == 4624 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["authentication"])
          event.set("[event][type]", ["start"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "logon"
          "[event][dataset]" => "updive-win.security.authentication"
        }
      }

      # Kirish turini xaritalash
      if [winlog][event_data][LogonType] {
        translate {
          source => "[winlog][event_data][LogonType]"
          target => "[winlog][logon][type_name]"
          dictionary => {
            "2" => "Interaktiv"
            "3" => "Tarmoq"
            "4" => "Partiya"
            "5" => "Xizmat"
            "7" => "Qulfni ochish"
            "8" => "TarmoqOchiqMatn"
            "9" => "YangiCredentials"
            "10" => "MasofadanInteraktiv"
            "11" => "KeshlangniInteraktiv"
          }
          fallback => "Noma'lum"
        }
      }
    }

    # 4625 - Muvaffaqiyatsiz kirish
    else if [winlog][event_id] == 4625 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["authentication"])
          event.set("[event][type]", ["start"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "failure"
          "[event][action]" => "logon"
          "[event][dataset]" => "updive-win.security.authentication"
        }
      }

      # Muvaffaqiyatsizlik sababini xaritalash
      if [winlog][event_data][Status] {
        translate {
          source => "[winlog][event_data][Status]"
          target => "[winlog][logon][failure_reason]"
          dictionary => {
            "0xC0000064" => "foydalanuvchi_topilmadi"
            "0xC000006A" => "noto'g'ri_parol"
            "0xC000006D" => "kirish_muvaffaqiyatsiz"
            "0xC000006E" => "hisob_cheklovi"
            "0xC000006F" => "noto'g'ri_kirish_vaqti"
            "0xC0000070" => "noto'g'ri_ish_stansiyasi"
            "0xC0000071" => "parol_muddati_o'tgan"
            "0xC0000072" => "hisob_o'chirilgan"
            "0xC0000193" => "hisob_muddati_o'tgan"
            "0xC0000224" => "parol_o'zgartirilishi_kerak"
            "0xC0000234" => "hisob_bloklangan"
          }
          fallback => "noma'lum_muvaffaqiyatsizlik"
        }
      }
    }

    # 4634/4647 - Chiqish
    else if [winlog][event_id] == 4634 or [winlog][event_id] == 4647 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["authentication"])
          event.set("[event][type]", ["end"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "logoff"
          "[event][dataset]" => "updive-win.security.authentication"
        }
      }
    }

    # -------------------------------------------------------------------------
    # HISOB BOSHQARUVI VOQEALARI
    # -------------------------------------------------------------------------
    # 4720 - Foydalanuvchi hisobi yaratildi
    else if [winlog][event_id] == 4720 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["user", "creation"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "user_account_created"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }

    # 4722/4725 - Hisob yoqildi/ochirildi
    else if [winlog][event_id] == 4722 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["user", "change"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "user_account_enabled"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }
    else if [winlog][event_id] == 4725 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["user", "change"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "user_account_disabled"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }

    # 4726 - Foydalanuvchi hisobi o'chirildi
    else if [winlog][event_id] == 4726 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["user", "deletion"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "user_account_deleted"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }

    # 4728/4732/4756 - Guruhga a'zo qo'shildi
    else if [winlog][event_id] == 4728 or [winlog][event_id] == 4732 or [winlog][event_id] == 4756 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["group", "change"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "group_member_added"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }

    # 4729/4733/4757 - Guruhdan a'zo olib tashlandi
    else if [winlog][event_id] == 4729 or [winlog][event_id] == 4733 or [winlog][event_id] == 4757 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["group", "change"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "group_member_removed"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }

    # 4724 - Parolni tiklash urinishi
    else if [winlog][event_id] == 4724 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["user", "change"])
        '
      }
      mutate {
        add_field => {
          "[event][action]" => "password_reset_attempt"
          "[event][dataset]" => "updive-win.security.account"
        }
      }
    }

    # -------------------------------------------------------------------------
    # IMTIYOZ VOQEALARI
    # -------------------------------------------------------------------------
    # 4672 - Maxsus imtiyozlar tayinlandi
    else if [winlog][event_id] == 4672 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["admin"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "special_privileges_assigned"
          "[event][dataset]" => "updive-win.security.privilege"
        }
      }
    }

    # 4673/4674 - Imtiyoz ishlatildi
    else if [winlog][event_id] == 4673 or [winlog][event_id] == 4674 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["iam"])
          event.set("[event][type]", ["admin"])
        '
      }
      mutate {
        add_field => {
          "[event][action]" => "privilege_used"
          "[event][dataset]" => "updive-win.security.privilege"
        }
      }
    }

    # -------------------------------------------------------------------------
    # JARAYON VOQEALARI
    # -------------------------------------------------------------------------
    # 4688 - Jarayon yaratildi
    else if [winlog][event_id] == 4688 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["process"])
          event.set("[event][type]", ["start"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "process_created"
          "[event][dataset]" => "updive-win.security.process"
        }
      }

      # Jarayon maydonlarini ECS ga xaritalash
      if [winlog][event_data][NewProcessName] {
        mutate {
          add_field => { "[process][executable]" => "%{[winlog][event_data][NewProcessName]}" }
        }
        ruby {
          code => '
            exe = event.get("[process][executable]")
            if exe
              event.set("[process][name]", File.basename(exe.to_s))
            end
          '
        }
      }

      if [winlog][event_data][NewProcessId] {
        mutate {
          add_field => { "[process][pid]" => "%{[winlog][event_data][NewProcessId]}" }
        }
        ruby {
          code => '
            pid = event.get("[process][pid]")
            if pid
              event.set("[process][pid]", pid.to_s.to_i(16))
            end
          '
        }
      }

      if [winlog][event_data][CommandLine] {
        mutate {
          add_field => { "[process][command_line]" => "%{[winlog][event_data][CommandLine]}" }
        }
      }

      if [winlog][event_data][ParentProcessName] {
        mutate {
          add_field => { "[process][parent][executable]" => "%{[winlog][event_data][ParentProcessName]}" }
        }
      }
    }

    # 4689 - Jarayon tugatildi
    else if [winlog][event_id] == 4689 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["process"])
          event.set("[event][type]", ["end"])
        '
      }
      mutate {
        add_field => {
          "[event][outcome]" => "success"
          "[event][action]" => "process_terminated"
          "[event][dataset]" => "updive-win.security.process"
        }
      }
    }

    # -------------------------------------------------------------------------
    # SIYOSAT O'ZGARISH VOQEALARI
    # -------------------------------------------------------------------------
    else if [winlog][event_id] >= 4704 and [winlog][event_id] <= 4719 {
      # ECS: category va type massiv sifatida
      ruby {
        code => '
          event.set("[event][category]", ["configuration"])
          event.set("[event][type]", ["change"])
        '
      }
      mutate {
        add_field => {
          "[event][action]" => "policy_change"
          "[event][dataset]" => "updive-win.security.policy"
        }
      }
    }

    # -------------------------------------------------------------------------
    # STANDART - Toifalanmagan Windows voqealari
    # -------------------------------------------------------------------------
    else {
      if ![event][category] {
        # ECS: category va type massiv sifatida
        ruby {
          code => '
            event.set("[event][category]", ["host"])
            event.set("[event][type]", ["info"])
          '
        }
        mutate {
          add_field => {
            "[event][dataset]" => "updive-win.security.other"
          }
        }
      }
    }

    # -------------------------------------------------------------------------
    # ECS STANDARTLARIGA O'TKAZISH (Normalization)
    # -------------------------------------------------------------------------
    # User va Target normalization
    if [winlog][event_data][TargetUserName] {
      mutate {
        copy => { "[winlog][event_data][TargetUserName]" => "[user][target][name]" }
      }
      # Guruhlar uchun maxsus (Security log hodisalari bo'yicha)
      if [event][code] in ["4728", "4732", "4756"] {
        mutate {
          copy => { "[winlog][event_data][TargetUserName]" => "[group][name]" }
        }
      }
    }

    if [winlog][event_data][SubjectUserName] and ![user][name] {
      mutate {
        copy => { "[winlog][event_data][SubjectUserName]" => "[user][name]" }
      }
    }

    if [winlog][event_data][AccountName] and ![user][name] {
      mutate {
        copy => { "[winlog][event_data][AccountName]" => "[user][name]" }
      }
    }

    if [winlog][event_data][TargetDomainName] and ![user][target][domain] {
      mutate {
        copy => { "[winlog][event_data][TargetDomainName]" => "[user][target][domain]" }
      }
    }

    if [winlog][event_data][SubjectDomainName] and ![user][domain] {
      mutate {
        copy => { "[winlog][event_data][SubjectDomainName]" => "[user][domain]" }
      }
    }

    # Process Monitoring
    if [winlog][event_data][ProcessName] {
      mutate {
        copy => { "[winlog][event_data][ProcessName]" => "[process][name]" }
      }
    }

    if [winlog][event_data][ParentProcessName] {
      mutate {
        copy => { "[winlog][event_data][ParentProcessName]" => "[process][parent][name]" }
      }
    }

    if [winlog][event_data][CommandLine] {
      mutate {
        copy => { "[winlog][event_data][CommandLine]" => "[process][command_line]" }
      }
    }

    if [winlog][event_data][ParentCommandLine] {
      mutate {
        copy => { "[winlog][event_data][ParentCommandLine]" => "[process][parent][command_line]" }
      }
    }

    # Network Fields
    if [winlog][event_data][DestPort] {
      mutate {
        copy => { "[winlog][event_data][DestPort]" => "[destination][port]" }
        convert => { "[destination][port]" => "integer" }
      }
    }

    if [winlog][event_data][DestAddress] {
      mutate {
        copy => { "[winlog][event_data][DestAddress]" => "[destination][ip]" }
      }
    }

    if [winlog][event_data][SourcePort] {
      mutate {
        copy => { "[winlog][event_data][SourcePort]" => "[source][port]" }
        convert => { "[source][port]" => "integer" }
      }
    }

    if [winlog][event_data][SourceAddress] {
      mutate {
        copy => { "[winlog][event_data][SourceAddress]" => "[source][ip]" }
      }
    }

    # Tarmoq kirishlari uchun eski formatdagi IpAddress va IpPort handling
    if [winlog][event_data][IpAddress] and [winlog][event_data][IpAddress] != "-" and ![source][ip] {
      mutate {
        add_field => { "[source][ip]" => "%{[winlog][event_data][IpAddress]}" }
      }
    }
    
    if [winlog][event_data][IpPort] and [winlog][event_data][IpPort] != "0" and ![source][port] {
      mutate {
        add_field => { "[source][port]" => "%{[winlog][event_data][IpPort]}" }
        convert => { "[source][port]" => "integer" }
      }
    }

    # GeoIP qidiruvi source.ip uchun
    if [source][ip] {
      geoip {
        source => "[source][ip]"
        target => "[source][geo]"
        ecs_compatibility => v8
        tag_on_failure => ["_geoip_source_failure"]
      }
    }

    # Logon/Kerberos
    if [winlog][event_data][LogonType] {
      mutate {
        copy => { "[winlog][event_data][LogonType]" => "[winlog][logon][type]" }
      }
    }

    if [winlog][event_data][AuthenticationPackageName] {
      mutate {
        copy => { "[winlog][event_data][AuthenticationPackageName]" => "[winlog][logon][authentication_package]" }
      }
    }

    # Registry
    if [winlog][event_data][TargetObject] {
      mutate {
        copy => { "[winlog][event_data][TargetObject]" => "[registry][path]" }
      }
    }

    # Host ma'lumotlari
    if [winlog][computer_name] and ![host][name] {
      mutate {
        add_field => { "[host][name]" => "%{[winlog][computer_name]}" }
      }
    }


    # -------------------------------------------------------------------------
    # Bog'liq maydonlar
    # -------------------------------------------------------------------------
    ruby {
      code => '
        related_ips = []
        related_users = []

        src_ip = event.get("[source][ip]")
        related_ips << src_ip if src_ip

        subject_user = event.get("[user][name]")
        related_users << subject_user if subject_user

        target_user = event.get("[user][target][name]")
        related_users << target_user if target_user

        event.set("[related][ip]", related_ips.uniq) unless related_ips.empty?
        event.set("[related][user]", related_users.uniq) unless related_users.empty?
      '
    }

    # -------------------------------------------------------------------------
    # Shovqin nazorati - shovqinli, past qiymatli Windows voqealarini tashlab yuborish
    # -------------------------------------------------------------------------
    # Mashina hisobi autentifikatsiyalarini tashlab yuborish ($bilan tugaydi)
    if [user][name] =~ /\$$/ and [winlog][event_id] == 4624 {
      if [winlog][event_data][LogonType] == "3" {
        drop { }
      }
    }

    # SYSTEM va mahalliy xizmat shovqinini ma'lum voqealar uchun tashlab yuborish
    if [user][name] =~ /^(SYSTEM|LOCAL SERVICE|NETWORK SERVICE|DWM-\d+|UMFD-\d+)$/ {
      if [winlog][event_id] == 4672 {
        drop { }
      }
    }

    # Keng tarqalgan shovqinli Event ID'larni tashlab yuborish
    if [winlog][event_id] in [5156, 5158, 4658, 4656] {
      # Bu juda yuqori hajmli filtrlash platformasi voqealari
      drop { }
    }
  }
}
