# =============================================================================
# 13-filter-updive-heart.conf - Heartbeat/updive-heart qayta ishlash
# Mavjudlik monitoringi va uptime voqealari
# =============================================================================

filter {
  if [@metadata][updive_type] == "heart" {

    # Asosiy voqea metadatasini ornatish
    mutate {
      add_field => {
        "[event][module]" => "updive-heart"
        "[event][kind]" => "event"
        "[event][category]" => "network"
      }
    }

    # -------------------------------------------------------------------------
    # Monitor holati asosida voqea natijasini aniqlash
    # -------------------------------------------------------------------------
    if [monitor][status] == "up" {
      mutate {
        add_field => {
          "[event][type]" => "connection"
          "[event][outcome]" => "success"
          "[event][action]" => "monitor_check"
        }
      }
    } else if [monitor][status] == "down" {
      mutate {
        add_field => {
          "[event][type]" => "connection"
          "[event][outcome]" => "failure"
          "[event][action]" => "monitor_check"
        }
      }
    } else {
      mutate {
        add_field => {
          "[event][type]" => "info"
          "[event][outcome]" => "unknown"
          "[event][action]" => "monitor_check"
        }
      }
    }

    # -------------------------------------------------------------------------
    # Monitor turi asosida dataset tayinlash
    # -------------------------------------------------------------------------
    if [monitor][type] {
      mutate {
        add_field => { "[event][dataset]" => "updive-heart.%{[monitor][type]}" }
      }
    } else {
      mutate {
        add_field => { "[event][dataset]" => "updive-heart.uptime" }
      }
    }

    # -------------------------------------------------------------------------
    # ECS ga maydonlarni normalizatsiya qilish
    # -------------------------------------------------------------------------
    # URL maydonlari
    if [url][full] and ![url][original] {
      mutate {
        add_field => { "[url][original]" => "%{[url][full]}" }
      }
    }

    # Maqsadli hostni destination sifatida
    if [monitor][ip] and ![destination][ip] {
      mutate {
        add_field => { "[destination][ip]" => "%{[monitor][ip]}" }
      }
    }

    if [url][domain] and ![destination][domain] {
      mutate {
        add_field => { "[destination][domain]" => "%{[url][domain]}" }
      }
    }

    if [url][port] and ![destination][port] {
      mutate {
        add_field => { "[destination][port]" => "%{[url][port]}" }
      }
    }

    # -------------------------------------------------------------------------
    # Kuzatilayotgan maqsadlar uchun xizmat maydonlari
    # -------------------------------------------------------------------------
    if [monitor][name] and ![service][name] {
      mutate {
        add_field => { "[service][name]" => "%{[monitor][name]}" }
      }
    }

    if [monitor][id] and ![service][id] {
      mutate {
        add_field => { "[service][id]" => "%{[monitor][id]}" }
      }
    }

    # -------------------------------------------------------------------------
    # HTTP-ga xos boyitish
    # -------------------------------------------------------------------------
    if [monitor][type] == "http" {
      if [http][response][status_code] {
        mutate {
          convert => { "[http][response][status_code]" => "integer" }
        }
      }

      # TLS/SSL malumotlari
      if [tls][established] {
        mutate {
          add_field => { "[network][protocol]" => "https" }
        }
      } else if [url][scheme] == "http" {
        mutate {
          add_field => { "[network][protocol]" => "http" }
        }
      }
    }

    # -------------------------------------------------------------------------
    # TCP-ga xos boyitish
    # -------------------------------------------------------------------------
    if [monitor][type] == "tcp" {
      mutate {
        add_field => { "[network][protocol]" => "tcp" }
        add_field => { "[network][transport]" => "tcp" }
      }
    }

    # -------------------------------------------------------------------------
    # ICMP-ga xos boyitish
    # -------------------------------------------------------------------------
    if [monitor][type] == "icmp" {
      mutate {
        add_field => { "[network][protocol]" => "icmp" }
      }
    }

    # -------------------------------------------------------------------------
    # destination uchun GeoIP boyitish
    # -------------------------------------------------------------------------
    if [destination][ip] {
      geoip {
        source => "[destination][ip]"
        target => "[destination][geo]"
        ecs_compatibility => v8
        tag_on_failure => ["_geoip_dest_failure"]
      }
    }

    # -------------------------------------------------------------------------
    # Bog'liq maydonlar
    # -------------------------------------------------------------------------
    ruby {
      code => '
        related_ips = []
        related_hosts = []

        dest_ip = event.get("[destination][ip]")
        related_ips << dest_ip if dest_ip

        monitor_ip = event.get("[monitor][ip]")
        related_ips << monitor_ip if monitor_ip

        url_domain = event.get("[url][domain]")
        related_hosts << url_domain if url_domain

        monitor_name = event.get("[monitor][name]")
        related_hosts << monitor_name if monitor_name

        event.set("[related][ip]", related_ips.uniq) unless related_ips.empty?
        event.set("[related][hosts]", related_hosts.uniq) unless related_hosts.empty?
      '
    }

    # -------------------------------------------------------------------------
    # Heartbeat-ga xos batafsil maydonlarni tozalash
    # -------------------------------------------------------------------------
    mutate {
      remove_field => [
        "[resolve]",
        "[tcp][rtt]",
        "[socks5]"
      ]
    }

    # -------------------------------------------------------------------------
    # Shovqin nazorati - har bir muvaffaqiyatli tekshiruvni log qilmaslik
    # -------------------------------------------------------------------------
    # Barcha muvaffaqiyatsizliklarni saqlash (ogohlantirish uchun muhim)
    # Hajmni kamaytirish uchun muvaffaqiyatli tekshiruvlarni tanlash
    if [event][outcome] == "success" {
      ruby {
        code => '
          # Muvaffaqiyatli tekshiruvlarning faqat 5 tadan 1 tasini saqlash (20%)
          if rand(5) != 0
            event.cancel
          end
        '
      }
    }
  }
}
