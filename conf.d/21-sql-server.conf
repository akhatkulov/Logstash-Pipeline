# MS SQL Server Security Filter (ECS 8.x)
# File: 21-sql-server.conf

filter {
  if [winlog][provider_name] == "MSSQLSERVER" or [winlog][source_name] == "MSSQLSERVER" {
    
    # 1. Event ID va Tagging
    mutate { add_field => { "[event][code]" => "%{[winlog][event_id]}" } }

    # Login xatoligi (18456)
    if [winlog][event_id] == 18456 {
      mutate { add_tag => ["Login_Failed"] }
      
      # IP va Userni extract qilish: [CLIENT: 192.168.1.50]
      grok {
        match => { "message" => "Login failed for user '%{DATA:[user][name]}'.*?\[CLIENT: %{IP:[source][ip]}\]" }
        tag_on_failure => ["_grok_mssql_ip_failed"]
      }
    }

    # Konfiguratsiya o'zgarishi (15457)
    if [winlog][event_id] == 15457 {
      mutate { add_tag => ["Config_Change"] }
    }

    # RCE belgilarini qidirish (xp_cmdshell)
    if [message] =~ /xp_cmdshell/ {
      mutate { add_tag => ["Potential_RCE"] }
    }

    # 2. SQL State kodlarini tarjima qilish (event.reason)
    if [winlog][event_data][State] {
      translate {
        field => "[winlog][event_data][State]"
        destination => "[event][reason]"
        dictionary => {
          "1" => "Account Locked"
          "2" => "Invalid User ID"
          "5" => "Invalid Password"
          "8" => "Password Incorrect"
          "11" => "Login valid but server access denied"
          "12" => "Login valid but database access denied"
          "18" => "Password expired"
          "38" => "Database not available"
        }
        fallback => "SQL State: %{[winlog][event_data][State]}"
      }
    }

    # 3. GeoIP (faqat tashqi IP bo'lsa)
    if [source][ip] and [source][ip] !~ /^(127\.|10\.|172\.1[6-9]\.|172\.2[0-9]\.|172\.3[0-1]\.|192\.168\.)/ {
      geoip { source => "[source][ip]" target => "[source][geo]" }
    }

    # 4. ECS Mapping (Qolgan maydonlar)
    mutate {
      add_field => { 
        "[event][module]" => "mssql" 
        "[event][dataset]" => "mssql.security"
        "[event][kind]" => "event"
        "[event][category]" => ["database", "iam"]
      }
      copy => { "[winlog][event_data][TargetUserName]" => "[user][target][name]" }
    }

    # 5. Tozalash (ixtiyoriy)
    # mutate { remove_field => ["message"] }
  }
}
